<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commander des cartes postales ‚Äì Les Aquarelles de Flo</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Styles locaux (optionnels : tu peux aussi d√©placer dans style.css) */
    .wrap { max-width: 900px; margin: 2rem auto; padding: 1.5rem; background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    h1, h2 { margin: .2em 0 .4em; }
    form label { display:block; margin:.8rem 0 .3rem; font-weight:600; }
    input, select, textarea { width:100%; padding:.65rem .8rem; border:1px solid #d0d7de; border-radius:8px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; }
    .muted { color:#555; font-size:.95rem; margin:.3rem 0 1rem; }
    .preview { display:flex; flex-wrap:wrap; gap:.6rem; margin-top:.6rem; }
    .preview img { width:96px; height:auto; border-radius:8px; border:1px solid #e5e7eb; }
    .cards-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:.6rem; }
    .card-check { border:1px solid #e5e7eb; border-radius:10px; padding:.5rem; display:flex; gap:.6rem; align-items:center; background:#fafafa; }
    .card-check img { width:64px; height:auto; border-radius:6px; border:1px solid #e5e7eb; }
    .actions { margin-top:1.2rem; display:flex; gap:.8rem; align-items:center; }
    .btn { background:#083b66; color:#fff; padding:.8rem 1.1rem; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
    .btn:disabled { opacity:.6; cursor:progress; }
    .note { font-size:.9rem; color:#444; }
    .success, .error { margin-top:1rem; padding:.8rem 1rem; border-radius:8px; }
    .success { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .error { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .hidden { display:none; }
    nav a { margin-right:.8rem; }
  </style>
</head>
<body>
  <header class="wrap" style="background:#f8fafc;">
    <img src="logo.png" alt="Logo Les Aquarelles de Flo" style="width:70px;height:70px;border-radius:50%;vertical-align:middle;">
    <h1>Commander des cartes postales</h1>
    <nav>
      <a href="index.html">Galerie</a>
      <a href="apropos.html">√Ä propos</a>
      <a href="contact.html">Contact</a>
      <a href="commande.html"><strong>Commander</strong></a>
    </nav>
  </header>

  <main class="wrap">
    <p class="muted">Choisissez un pack pr√©-s√©lectionn√© (2, 3 ou 5 cartes) ou cr√©ez votre s√©lection personnalis√©e (jusqu‚Äô√† 5). Les miniatures s‚Äôaffichent automatiquement.</p>

    <form id="orderForm" method="POST" action="YOUR_APPS_SCRIPT_WEB_APP_URL">
      <!-- important : pour le fallback POST classique -->
      <input type="hidden" name="form-name" value="commande">
      <!-- on stockera la s√©lection finale pour le fallback -->
      <input type="hidden" name="selectedCards" id="selectedCardsHidden">

      <h2>Votre s√©lection</h2>
      <label for="pack">Pack :</label>
      <select id="pack" name="pack" required>
        <option value="">-- S√©lectionner --</option>
        <option value="pack2">Pack de 2 cartes</option>
        <option value="pack3">Pack de 3 cartes</option>
        <option value="pack5">Pack de 5 cartes</option>
        <option value="custom">S√©lection personnalis√©e (jusqu‚Äô√† 5)</option>
      </select>

      <!-- Aper√ßu dynamique -->
      <div class="preview" id="preview"></div>

      <!-- S√©lection personnalis√©e (cach√©e tant que non choisie) -->
      <div id="customBlock" class="hidden">
        <p class="muted">Cochez jusqu‚Äô√† 5 cartes :</p>
        <div id="cardsGrid" class="cards-grid"></div>
      </div>

      <h2>Coordonn√©es</h2>
      <div class="row">
        <div>
          <label>Nom complet</label>
          <input type="text" name="nom" required>
        </div>
        <div>
          <label>Email</label>
          <input type="email" name="email" required>
        </div>
      </div>

      <label>Adresse de livraison</label>
      <textarea name="adresse" rows="3" required placeholder="Rue, ville, code postal, pays"></textarea>

      <div class="row">
        <div>
          <label>Mode de paiement</label>
          <select name="paiement" required>
            <option value="Virement bancaire">Virement bancaire</option>
            <option value="PayPal">PayPal</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        <div>
          <label>Notes (optionnel)</label>
          <input type="text" name="notes" placeholder="Message au vendeur...">
        </div>
      </div>

      <div class="actions">
        <button class="btn" type="submit" id="submitBtn">Envoyer la commande</button>
        <span id="status" class="note"></span>
      </div>

      <div id="successBox" class="success hidden">Merci ! Votre commande a bien √©t√© envoy√©e. Vous recevrez un email de confirmation de ma part sous peu.</div>
      <div id="errorBox" class="error hidden">Oups, l‚Äôenvoi a √©chou√©. R√©essayez, ou votre navigateur va basculer en mode envoi classique.</div>
    </form>
  </main>

  <footer class="wrap" style="background:#f8fafc;">
    ¬© 2025 Les Aquarelles de Flo ‚Äì Go with the Flo üé®üö≤
  </footer>

  <script>
    // -------------- CONFIG --------------
    const APPS_SCRIPT_URL = "YOUR_APPS_SCRIPT_WEB_APP_URL"; // <-- remplace par ton URL .../exec

    // Packs (par titres d'≈ìuvres ‚Äî correspondent aux captions de images.json)
    const packDefinitions = {
      pack2: ["Lac Atitl√°n", "Haiku √† la Lune"],
      pack3: ["Golden Downhill", "√âl√©ments de vie", "Restaurant Japonais"],
      pack5: ["Lac Atitl√°n", "Haiku √† la Lune", "Restaurant Japonais", "Rue du march√© de San Pedro", "Danse des √©motions"]
    };

    // On va charger images.json pour relier "caption" -> "src"
    let allCards = [];          // [{caption, src, alt}]
    let byCaption = {};         // caption -> {src, alt}

    const packSelect = document.getElementById("pack");
    const preview = document.getElementById("preview");
    const customBlock = document.getElementById("customBlock");
    const cardsGrid = document.getElementById("cardsGrid");
    const form = document.getElementById("orderForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");
    const successBox = document.getElementById("successBox");
    const errorBox = document.getElementById("errorBox");
    const hiddenSelected = document.getElementById("selectedCardsHidden");

    // Limite de s√©lection personnalis√©e
    const CUSTOM_LIMIT = 5;

    // Charger les cartes depuis images.json
    fetch("images.json")
      .then(r => r.json())
      .then(images => {
        allCards = images.map(img => ({
          caption: img.caption,
          src: img.src,
          alt: img.alt || (img.caption + " ‚Äì Aquarelle de Flo")
        }));
        byCaption = Object.fromEntries(allCards.map(c => [c.caption, c]));
        buildCustomGrid();
      })
      .catch(err => {
        console.error("Impossible de charger images.json", err);
      });

    function buildCustomGrid() {
      cardsGrid.innerHTML = "";
      allCards.forEach(card => {
        const div = document.createElement("label");
        div.className = "card-check";
        div.innerHTML = `
          <input type="checkbox" name="customCard" value="${card.caption}">
          <img src="${card.src}" alt="${card.alt}" loading="lazy">
          <span>${card.caption}</span>
        `;
        // G√©rer la limite de 5
        const checkbox = div.querySelector('input[type="checkbox"]');
        checkbox.addEventListener("change", () => {
          const checked = getCustomChecked();
          if (checked.length > CUSTOM_LIMIT) {
            checkbox.checked = false;
            alert("Vous pouvez s√©lectionner au maximum " + CUSTOM_LIMIT + " cartes.");
            return;
          }
          updatePreview();
        });
        cardsGrid.appendChild(div);
      });
    }

    function getCustomChecked() {
      return Array.from(document.querySelectorAll('input[name="customCard"]:checked'))
                  .map(el => el.value);
    }

    packSelect.addEventListener("change", updatePreview);

    function updatePreview() {
      preview.innerHTML = "";
      successBox.classList.add("hidden");
      errorBox.classList.add("hidden");

      if (packSelect.value === "custom") {
        customBlock.classList.remove("hidden");
        // Afficher les miniatures coch√©es
        getCustomChecked().forEach(caption => {
          const card = byCaption[caption];
          if (card) addThumb(card.src, card.alt);
        });
      } else {
        customBlock.classList.add("hidden");
        const names = packDefinitions[packSelect.value] || [];
        names.forEach(caption => {
          const card = byCaption[caption];
          if (card) addThumb(card.src, card.alt);
        });
      }
      // Met √† jour le champ cach√© pour le fallback
      hiddenSelected.value = JSON.stringify(getCurrentSelection());
    }

    function addThumb(src, alt) {
      const img = document.createElement("img");
      img.src = src;
      img.alt = alt;
      img.loading = "lazy";
      preview.appendChild(img);
    }

    function getCurrentSelection() {
      if (packSelect.value === "custom") {
        return getCustomChecked();
      }
      const names = packDefinitions[packSelect.value] || [];
      return names;
    }

    // Soumission AJAX vers Google Apps Script (avec fallback en POST classique)
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "Envoi en cours‚Ä¶";
      submitBtn.disabled = true;
      successBox.classList.add("hidden");
      errorBox.classList.add("hidden");

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      payload.selectedCards = getCurrentSelection();
      payload.pack = packSelect.value;
      payload.userAgent = navigator.userAgent;

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        // Beaucoup d'Apps Script renvoient bien du JSON ; on tente de lire, sinon on continue.
        let ok = res.ok;
        try {
          const data = await res.json();
          ok = ok && (data.ok === true || data.result === "success");
        } catch(_) {}

        if (ok) {
          statusEl.textContent = "";
          successBox.classList.remove("hidden");
          form.reset();
          preview.innerHTML = "";
          customBlock.classList.add("hidden");
        } else {
          throw new Error("R√©ponse inattendue du serveur");
        }
      } catch (err) {
        // Fallback : soumission classique vers l'action (ouvre la page Apps Script)
        console.warn("AJAX √©chou√©, fallback POST classique :", err);
        statusEl.textContent = "√âchec AJAX, bascule en envoi classique‚Ä¶";
        hiddenSelected.value = JSON.stringify(getCurrentSelection());
        submitBtn.disabled = false;
        form.submit();
        return;
      }

      submitBtn.disabled = false;
    });
  </script>
</body>
</html>
