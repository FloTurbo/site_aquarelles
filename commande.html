<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commander des cartes postales â€“ Les Aquarelles de Flo</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .wrap { max-width: 900px; margin: 2rem auto; padding: 1.5rem; background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    h1, h2 { margin: .2em 0 .4em; }
    form label { display:block; margin:.8rem 0 .3rem; font-weight:600; }
    input, select, textarea { width:100%; padding:.65rem .8rem; border:1px solid #d0d7de; border-radius:8px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .muted { color:#555; font-size:.95rem; margin:.3rem 0 1rem; }
    .preview { display:flex; flex-wrap:wrap; gap:.6rem; margin-top:.6rem; }
    .preview img { width:96px; height:auto; border-radius:8px; border:1px solid #e5e7eb; object-fit:contain; }
    .actions { margin-top:1.2rem; display:flex; gap:.8rem; align-items:center; }
    .btn { background:#083b66; color:#fff; padding:.8rem 1.1rem; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
    .btn:disabled { opacity:.6; cursor:progress; }
    .note { font-size:.9rem; color:#444; }
    .success, .error { margin-top:1rem; padding:.8rem 1rem; border-radius:8px; }
    .success { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .error { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .hidden { display:none; }
    nav a { margin-right:.8rem; }
  </style>
</head>
<body>
  <header class="wrap" style="background:#f8fafc;">
    <img src="logo.png" alt="Logo Les Aquarelles de Flo" style="width:70px;height:70px;border-radius:50%;vertical-align:middle;">
    <h1>Commander des cartes postales</h1>
    <nav>
      <a href="index.html">Galerie</a>
      <a href="commande.html"><strong>Commander</strong></a>
      <a href="apropos.html">Ã€ propos</a>
      <a href="contact.html">Contact</a>
    </nav>
  </header>

  <main class="wrap">
    <p class="muted">Choisissez un pack (prÃ©-sÃ©lectionnÃ© ou personnalisÃ©). Les miniatures des cartes sâ€™affichent automatiquement.</p>

    <form id="orderForm" method="POST" action="https://script.google.com/macros/s/AKfycbwQxXk6tE6mmrGKSsD0vz9HJw9ZYJmqlZkoR6An__jlV1AaOFW7lXQdq2MzV_sf_jGxJQ/exec">
      <input type="hidden" name="form-name" value="commande">
      <input type="hidden" name="selectedCards" id="selectedCardsHidden">

      <h2>Votre sÃ©lection</h2>
      <label for="pack">Pack :</label>
      <select id="pack" name="pack" required>
        <option value="">-- SÃ©lectionner --</option>
        <option value="volcan">Pack Volcan â€“ Soutien de feu (20$)</option>
        <option value="lac">Pack du Lac â€“ Soutien du cÅ“ur (30$)</option>
        <option value="super">Super Pack â€“ Soutien Total (50$)</option>
        <option value="custom">SÃ©lection du cÅ“ur (jusquâ€™Ã  5 cartes)</option>
      </select>

      <!-- AperÃ§u dynamique -->
      <div class="preview" id="preview"></div>

      <!-- SÃ©lection personnalisÃ©e -->
      <div id="customBlock" class="hidden">
        <p class="muted">Cochez jusquâ€™Ã  5 cartes :</p>
        <div id="cardsGrid"></div>
      </div>

      <h2>CoordonnÃ©es</h2>
      <div class="row">
        <div>
          <label>Nom complet</label>
          <input type="text" name="nom" required>
        </div>
        <div>
          <label>Email</label>
          <input type="email" name="email" required>
        </div>
      </div>

      <label>Adresse de livraison</label>
      <textarea name="adresse" rows="3" required placeholder="Rue, ville, code postal, pays"></textarea>

      <div class="row">
        <div>
          <label>Mode de paiement</label>
          <select name="paiement" required>
            <option value="Virement bancaire">Virement bancaire</option>
            <option value="PayPal">PayPal</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        <div>
          <label>Notes (optionnel)</label>
          <input type="text" name="notes" placeholder="Message au vendeur...">
        </div>
      </div>

      <div class="actions">
        <button class="btn" type="submit" id="submitBtn">Envoyer la commande</button>
        <span id="status" class="note"></span>
      </div>

      <div id="successBox" class="success hidden">
        âœ… Merci ! Votre commande a bien Ã©tÃ© envoyÃ©e.  
        Vous serez redirigÃ© vers la galerie dans quelques secondesâ€¦
      </div>
      <div id="errorBox" class="error hidden">Oups, lâ€™envoi a Ã©chouÃ©. RÃ©essayez plus tard.</div>
    </form>
  </main>

  <footer class="wrap" style="background:#f8fafc;">
    Â© 2025 Les Aquarelles de Flo â€“ Go with the Flo ðŸŽ¨ðŸš²
  </footer>

  <script>
    // URL de ton Apps Script
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQxXk6tE6mmrGKSsD0vz9HJw9ZYJmqlZkoR6An__jlV1AaOFW7lXQdq2MzV_sf_jGxJQ/exec"; 
    
    // Packs
    const packDefinitions = {
      volcan: ["Golden Downhill", "El Fuego"],
      lac: ["Restaurant Japonais", "Ã‰lÃ©ments de vie", "Rue du marchÃ©"],
      super: ["Golden Downhill", "El Fuego", "Restaurant Japonais", "Ã‰lÃ©ments de vie", "Rue du marchÃ©"]
    };

    let allCards = [];  // [{caption, src, alt}]
    let byCaption = {}; // caption -> card

    const packSelect = document.getElementById("pack");
    const preview = document.getElementById("preview");
    const customBlock = document.getElementById("customBlock");
    const cardsGrid = document.getElementById("cardsGrid");
    const form = document.getElementById("orderForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");
    const successBox = document.getElementById("successBox");
    const errorBox = document.getElementById("errorBox");
    const hiddenSelected = document.getElementById("selectedCardsHidden");
    const CUSTOM_LIMIT = 5;

    // Charger les cartes
    fetch("images.json")
      .then(r => r.json())
      .then(images => {
        allCards = images.map(img => ({
          caption: img.caption,
          src: img.src,
          alt: img.alt || img.caption
        }));
        byCaption = Object.fromEntries(allCards.map(c => [c.caption, c]));
        buildCustomGrid();
      });

    function buildCustomGrid() {
      cardsGrid.innerHTML = "";
      allCards.forEach(card => {
        const div = document.createElement("label");
        div.style.display = "block";
        div.innerHTML = `
          <input type="checkbox" name="customCard" value="${card.caption}">
          <img src="${card.src}" alt="${card.alt}" style="width:70px;height:auto;vertical-align:middle;margin:0 8px;">
          ${card.caption}
        `;
        const checkbox = div.querySelector("input");
        checkbox.addEventListener("change", () => {
          const checked = getCustomChecked();
          if (checked.length > CUSTOM_LIMIT) {
            checkbox.checked = false;
            alert("Maximum " + CUSTOM_LIMIT + " cartes.");
            return;
          }
          updatePreview();
        });
        cardsGrid.appendChild(div);
      });
    }

    function getCustomChecked() {
      return Array.from(document.querySelectorAll('input[name="customCard"]:checked'))
                  .map(el => el.value);
    }

    packSelect.addEventListener("change", updatePreview);

    function updatePreview() {
      preview.innerHTML = "";
      successBox.classList.add("hidden");
      errorBox.classList.add("hidden");

      if (packSelect.value === "custom") {
        customBlock.classList.remove("hidden");
        getCustomChecked().forEach(caption => {
          const card = byCaption[caption];
          if (card) addThumb(card.src, card.alt);
        });
      } else {
        customBlock.classList.add("hidden");
        const names = packDefinitions[packSelect.value] || [];
        names.forEach(caption => {
          const card = byCaption[caption];
          if (card) addThumb(card.src, card.alt);
        });
      }
      hiddenSelected.value = JSON.stringify(getCurrentSelection());
    }

    function addThumb(src, alt) {
      const img = document.createElement("img");
      img.src = src;
      img.alt = alt;
      preview.appendChild(img);
    }

    function getCurrentSelection() {
      if (packSelect.value === "custom") return getCustomChecked();
      return packDefinitions[packSelect.value] || [];
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "Envoi en coursâ€¦";
      submitBtn.disabled = true;
      successBox.classList.add("hidden");
      errorBox.classList.add("hidden");

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      payload.selectedCards = getCurrentSelection();
      payload.pack = packSelect.value;

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          statusEl.textContent = "";
          successBox.classList.remove("hidden");
          form.reset();
          preview.innerHTML = "";
          customBlock.classList.add("hidden");
          setTimeout(() => { window.location.href = "index.html"; }, 3000);
        } else throw new Error("Erreur serveur");
      } catch (err) {
        errorBox.classList.remove("hidden");
      }

      submitBtn.disabled = false;
    });
  </script>
</body>
</html>
